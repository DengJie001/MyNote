# 微服务
服务化，也就是把一个大项目中的多个模块拆分成多个独立的小项目
- 粒度小
- 团队自治
- 服务自治

# SpringCloud


# 服务治理-注册中心
## 三种角色
- 服务提供者：暴露服务接口，给其他服务使用
- 服务消费者：调用其他服务的接口
- 注册中心：记录并且监控微服务的实例状态，推送服务变更信息

## 消费者怎么知道服务提供者的具体地址
服务提供者会在启动时将自己的服务信息注册到注册中心，消费者可以从注册中心去拉取服务提供者的相关信息

## 消费者怎么知道服务提供者的状态变更
服务提供者会通过心跳机制向注册中心报告自己的健康状态，当心跳异常的时候，注册中心会将服务从服务列表中移除，并且通知订阅了这个服务的消费者

## 当提供者有多个实例的时候，消费者怎么选择
通过负载均衡机制选择一个最合适的服务提供者

## 服务注册步骤
### 引入nacos依赖
```xml
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
```

### 配置nacos地址
```yaml
spring:
  application:
    name: item-service  # 微服务名称
  cloud:
    nacos:
      server-addr: 1.95.50.31
```

## 服务发现
### 引入依赖

### 配置nacos地址

### 服务发现
```java
        // 2.查询商品
        // 2.1 根据服务名称获取服务的实例列表
        List<ServiceInstance> instances = discoveryClient.getInstances("item-service");
        if (CollUtil.isEmpty(instances)) {
            return;
        }
        // 2.2 负载均衡
        ServiceInstance serviceInstance = instances.get(RandomUtil.randomInt(instances.size()));
```


# OpenFeign
声明式的http客户端，主要用来做服务间http请求和通信

## 快速入门
### 引入依赖
```xml
        <!-- openfeign -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>

        <!-- 负载均衡 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
```


### 通过@EnableFeignClients注解启用OpenFeign功能
```java
@MapperScan("com.hmall.cart.mapper")
@SpringBootApplication
@EnableFeignClients
public class CartApplication {
    public static void main(String[] args) {
        SpringApplication.run(CartApplication.class, args);
    }
}
```

### 编写FeignClient
```java
@FeignClient("item-service")
public interface ItemClient {
    @GetMapping("/items")
    List<ItemDTO> queryItemsByIds(@RequestParam("ids") Collection<String> ids);
}

```

### 远程调用
```java
List<ItemDTO> items = itemClient.queryItemsByIds(itemIds);
```

## 连接池
OpenFeign对http请求做了封装，但实现方式依赖Client，这种方式下，每一次请求都会创建一个Client对象，效率比较低下
但，OpenFeign支持我们使用其他方式来实现http请求的封装，主要有以下三种：
- HttpURLConnection：默认实现，不支持连接池
- ApacheHttpClient：支持连接池
- OKHttp：支持连接池
具体的源码参考：FeignBlockingLoadBalancerClient.class中的delegate

### 如何使用自定义的http框架
#### 引入http依赖
```xml
        <dependency>
            <groupId>io.github.openfeign</groupId>
            <artifactId>feign-okhttp</artifactId>
        </dependency>
```

#### 开启OpenFeign的连接池功能
```yaml
feign:
  okhttp:
    enabled: true
```